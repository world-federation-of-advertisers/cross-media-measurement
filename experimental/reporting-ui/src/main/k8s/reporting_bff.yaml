// Copyright 2020 The Cross-Media Measurement Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

apiVersion: v1
kind: List
items:
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: reporting-bff-v1alpha-public-api-server-deployment
      labels:
        app.kubernetes.io/name: reporting-bff-v1alpha-public-api-server-deployment
        app.kubernetes.io/component: reporting-bff
        app: reporting-bff-v1alpha-public-api-server-app
        app.kubernetes.io/part-of: halo-cmms
      annotations:
        system: reporting-bff
    spec:
      selector:
        matchLabels:
          app: reporting-bff-v1alpha-public-api-server-app
      template:
        metadata:
          labels:
            app: reporting-bff-v1alpha-public-api-server-app
        spec:
          restartPolicy: Always
          serviceAccountName: reporting-bff-server
          containers:
            - args:
                - --reporting-api-target=v2alpha.reporting.dev.halo-cmm.org:8443
                - --tls-cert-file=/var/run/secrets/files/mc_tls.pem
                - --tls-key-file=/var/run/secrets/files/mc_tls.key
                - --cert-collection-file=/var/run/secrets/files/all_root_certs.pem
                - --require-client-auth=false
                - --reporting-api-certHost=localhost
                - --health-port=8000
              resources:
                limits:
                  memory: 256Mi
                requests:
                  cpu: 25m
                  memory: 256Mi
              name: reporting-v1alpha-public-api-server-container
              image: gcr.io/halo-cmm-dev/reporting-bff/v1/v1alpha-public-api:build-0001
              imagePullPolicy: Always
              ports:
                - containerPort: 8443
              volumeMounts:
                - name: reporting-v2alpha-public-api-server-files
                  mountPath: /var/run/secrets/files
                  readOnly: true
          volumes:
            - secret:
                secretName: signing-h98g2ddfgf
              name: reporting-v2alpha-public-api-server-files
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: reporting-bff-gateway-v1alpha-public-api-server-deployment
      labels:
        app.kubernetes.io/name: reporting-bff-gateway-v1alpha-public-api-server-deployment
        app.kubernetes.io/component: reporting-bff-gateway
        app: reporting-bff-gateway-v1alpha-public-api-server-app
        app.kubernetes.io/part-of: halo-cmms
      annotations:
        system: reporting-bff-gateway
    spec:
      selector:
        matchLabels:
          app: reporting-bff-gateway-v1alpha-public-api-server-app
      template:
        metadata:
          labels:
            app: reporting-bff-gateway-v1alpha-public-api-server-app
        spec:
          restartPolicy: Always
          serviceAccountName: reporting-bff-gateway-server
          containers:
            - args:
                - --tls_cert=/var/run/secrets/files/mc_tls.pem
                - --tls_key=/var/run/secrets/files/mc_tls.key
                - --endpoint=34.121.171.2:8443
                - --port=8080
              resources:
                limits:
                  memory: 256Mi
                requests:
                  cpu: 25m
                  memory: 256Mi
              name: reporting-gateway-v1alpha-public-api-server-container
              image: gcr.io/halo-cmm-dev/reporting-bff-gateway/v1/v1alpha-public-api:build-0001
              imagePullPolicy: Always
              ports:
                - containerPort: 8080
              volumeMounts:
                - name: reporting-gateway-v1alpha-public-api-server-files
                  mountPath: /var/run/secrets/files
                  readOnly: true
          volumes:
            - secret:
                secretName: signing-h98g2ddfgf
              name: reporting-gateway-v1alpha-public-api-server-files
  - apiVersion: v1
    kind: Service
    metadata:
      name: reporting-bff-server
      labels:
        app.kubernetes.io/name: reporting-bff-server
        app.kubernetes.io/component: reporting-bff
        app.kubernetes.io/part-of: halo-cmms
      annotations:
        system: reporting-bff
        cloud.google.com/app-protocols: '{"grpc-port": "HTTP2"}'
        kubernetes.io/ingress.allow-http: "false"
    spec:
      selector:
        app: reporting-bff-v1alpha-public-api-server-app
      ports:
        - port: 8443
          name: grpc-port
      type: LoadBalancer
      loadBalancerIP: 34.121.171.2
  - apiVersion: v1
    kind: Service
    metadata:
      name: reporting-bff-gateway-server
      labels:
        app.kubernetes.io/name: reporting-bff-gateway-server
        app.kubernetes.io/component: reporting-bff-gateway
        app.kubernetes.io/part-of: halo-cmms
      annotations:
        system: reporting-bff-gateway
        cloud.google.com/app-protocols: '{"rest-port": "HTTP2"}'
        kubernetes.io/ingress.allow-http: "true"
    spec:
      selector:
        app: reporting-bff-gateway-v1alpha-public-api-server-app
      ports:
        - port: 8080
          name: rest-port
      type: LoadBalancer
      loadBalancerIP: 34.41.59.152
  - apiVersion: networking.k8s.io/v1
    kind: NetworkPolicy
    metadata:
      name: reporting-bff-v1alpha-public-api-server-network-policy
      labels:
        app.kubernetes.io/part-of: halo-cmms
    spec:
      podSelector:
        matchLabels:
          app: reporting-bff-v1alpha-public-api-server-app
      policyTypes:
        - Ingress
        - Egress
      ingress:
        - from:
            - podSelector:
                matchLabels:
                  app: reporting-bff-gateway-v1alpha-public-api-server-app
          ports: []
        - from: []
          ports:
            - port: 8443
      egress:
        - to: []
          ports: []
