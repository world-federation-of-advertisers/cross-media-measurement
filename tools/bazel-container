#!/usr/bin/env bash

# Copyright 2021 The Cross-Media Measurement Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

set -eEu -o pipefail

readonly IMAGE="${IMAGE:-docker.io/wfameasurement/bazel@sha256:a1fee281b05fdaa769ff4e1d85cba831c046fbd7f177f31c06f3bf3840f4dec0}"
readonly DOCKER="${DOCKER:-docker}"
readonly CONTAINER_HOME="/tmp/home/${USER}"
readonly OUTPUT_USER_ROOT="${CONTAINER_HOME}/.cache/bazel/_bazel_${USER}"
readonly REPO_CACHE="${CONTAINER_HOME}/repo-cache"
readonly WORKING_DIR="${CONTAINER_HOME}/workspace"
readonly BAZELISK_HOME="${CONTAINER_HOME}/.cache/bazelisk"
readonly OUTPUT_VOLUME='bazel-output'

check_bash_version() {
  if [[ "${BASH_VERSINFO:-0}" -lt 5 ]]; then
    echo "Bash version ${BASH_VERSION:-unknown} is too old" >&2
    exit 1
  fi
}

is_podman() {
  [[ "$($DOCKER -v)" == *podman* ]]
}

is_rootless() {
  if is_podman; then
    [[ "$($DOCKER info --format '{{.Host.Security.Rootless}}')" == 'true' ]]
    return
  fi

  [[ "$($DOCKER info --format '{{.SecurityOptions}}')" == *rootless* ]] ||
    [[ "$($DOCKER version --format '{{.Client.Os}}')" == 'darwin' ]]
}

# Outputs the host's Bazel output user root.
# See https://docs.bazel.build/versions/4.2.1/output_directories.html
get_host_output_user_root() {
  local output_root
  if [[ "${OSTYPE}" == 'darwin'* ]]; then
    output_root='/private/var/tmp'
  else
    output_root="${HOME}/.cache/bazel"
  fi
  echo "${output_root}/_bazel_${USER}"
}

get_host_cache_dir() {
  if [[ -v XDG_CACHE_HOME ]]; then
    echo "${XDG_CACHE_HOME}"
  elif [[ "${OSTYPE}" == 'darwin'* ]]; then
    echo "${HOME}/Library/Caches"
  else
    echo "${HOME}/.cache"
  fi
}

ensure_host_bazelisk_cache_dir() {
  local host_cache_dir
  host_cache_dir="$(get_host_cache_dir)"
  readonly host_cache_dir

  readonly bazelisk_cache_dir="${host_cache_dir}/bazelisk"
  mkdir -p "${bazelisk_cache_dir}"
  echo "${bazelisk_cache_dir}"
}

main() {
  check_bash_version

  local host_output_user_root
  host_output_user_root="$(get_host_output_user_root)"
  local host_repo_cache="${host_output_user_root}/cache/repos/v1"
  mkdir -p "${host_repo_cache}"

  local host_bazelisk_cache_dir
  host_bazelisk_cache_dir="$(ensure_host_bazelisk_cache_dir)"
  readonly host_bazelisk_cache_dir

  local -a docker_options=(
    '-it'
    '--rm'
    '--network=host'
    '--entrypoint=/usr/bin/bazel'
    '--env'
      "HOME=${CONTAINER_HOME}"
    '--env'
      "BAZELISK_HOME=${BAZELISK_HOME}"
    '--mount'
      "type=bind,source=${PWD},target=${WORKING_DIR},readonly"
    '--mount'
      "type=bind,source=${host_repo_cache},target=${REPO_CACHE}"
    '--mount'
      "type=bind,source=${host_bazelisk_cache_dir},target=${BAZELISK_HOME}"
    '--mount'
      "type=volume,source=${OUTPUT_VOLUME},target=${OUTPUT_USER_ROOT}"
    "--workdir=${WORKING_DIR}"
  )

  if ! is_rootless; then
    docker_options+=(
      "--user=${EUID}:$(id -g)"
      "--env=USER=${USER}"
    )
  fi

  local -a startup_options=(
    "--output_user_root=${OUTPUT_USER_ROOT}"
  )
  while [[ "$1" =~ [[:space:]]*-.* ]]; do
    startup_options+=("$1")
    shift 1
  done

  local command="$1"
  shift 1

  echo "Running in Bazel container with output volume ${OUTPUT_VOLUME}:" \
    "${command} $*" >&2

  exec "${DOCKER}" run "${docker_options[@]}" \
    "${IMAGE}" \
    "${startup_options[@]}" \
    "${command}" \
    --config=container \
    --repository_cache="${REPO_CACHE}" \
    --experimental_convenience_symlinks=ignore \
    "$@"
}

main "$@"
