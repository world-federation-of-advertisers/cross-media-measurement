# Compression Dictionaries

In the "event preprocessing" step, events are grouped by joinkey, combined into
a `CombinedEvents` proto, serialized, compressed, and finally encrypted.

The recommended way to perform this encryption is by using
[Brotli](https://github.com/google/brotli). Support for this is built in. Brotli
works best when provided with a dictionary.

The rest of this guide shows how to build and evaluate a dictionary. To get
started, set up a base directory:

```shell
$ export BASE_DIR=/tmp/compression-dictionaries
$ cd $BASE_DIR
$ mkdir training testing
```

To build a dictionary, one first needs some samples. These can be generated by
using the tool in the `virtual_people_examples` repository:

```shell
$ git clone https://github.com/world-federation-of-advertisers/virtual_people_examples.git
$ cd $BASE_DIR/virtual_people_examples
$ bazel build //src/main/cc/wfa/virtual_people/events_generator:events_generator_main
$ bazel-bin/src/main/cc/wfa/virtual_people/events_generator/events_generator_main \
    --num_events=1000 \
    --format=binary \
    --output_dir=$BASE_DIR/training/
$ bazel-bin/src/main/cc/wfa/virtual_people/events_generator/events_generator_main \
    --num_events=10 \
    --format=binary \
    --output_dir=$BASE_DIR/testing/
$ cat $BASE_DIR/testing/*.pb > $BASE_DIR/testing/combined.pb
```

Next, we use the files in `$BASE_DIR/training` to build a dictionary. This could
be used as a dictionary itself, but it contains a lot of redundant information.

```shell
$ cd $BASE_DIR
$ git clone https://github.com/google/brotli
$ cd brotli/research
$ bazel build :dictionary_generator
$ bazel-bin/dictionary_generator --purify $BASE_DIR/training/*.pb
$ bazel-bin/dictionary_generator $BASE_DIR/dictionary $BASE_DIR/training/*.pb
```

Now `$BASE_DIR/dictionary` should be a compression dictionary. Let's test how it
works.

```shell
$ cd $BASE_DIR/brotli
$ bazel build :brotli
$ bazel-bin/brotli --keep --dictionary=$BASE_DIR/dictionary --best \
    --output=$BASE_DIR/compressed-events-with-dictionary \
    $BASE_DIR/testing/combined.pb
$ bazel-bin/brotli --keep --best \
    --output=$BASE_DIR/compressed-events-without-dictionary \
    $BASE_DIR/testing/combined.pb
$ ls -lh $BASE_DIR/compressed-events-*
```

This should show how much the dictionary aided with compression.

If you look at the dictionary itself, it will likely contain some nonsensical
fake PII. There is likely a better way to build the dictionary that avoids this.
