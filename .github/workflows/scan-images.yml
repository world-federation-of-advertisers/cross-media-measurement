# Copyright 2024 The Cross-Media Measurement Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Scan container images

on:
  workflow_call:
    inputs:
      container-registry:
        description: Container registry to pull images from
        type: string
        required: true
      image-repo-prefix:
        description: Common prefix of the image repository
        type: string
        required: true
      image-tag:
        description: Tag of container images
        type: string
        required: true
  workflow_dispatch:
    inputs:
      container-registry:
        description: Container registry to pull images from
        type: string
        required: true
      image-repo-prefix:
        description: Common prefix of the image repository
        type: string
        required: true
      image-tag:
        description: Tag of container images
        type: string
        required: true

permissions:
  contents: read

jobs:
  scan-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        # List of images obtained from the execution of 
        # https://github.com/world-federation-of-advertisers/cross-media-measurement/blob/v0.5.30/.github/workflows/push-images.yml#L74
        # for nightly/20260104.2.
        # This list must be manually maintained as there is no known way to
        # populate it from the GitHub API or the build system.
        image:
          - access/internal-api
          - access/public-api
          - access/update-schema
          - data-provider/population-requisition-fulfiller
          - duchy/async-computation-control
          - duchy/aws-computation-control
          - duchy/aws-herald
          - duchy/aws-honest-majority-share-shuffle-mill
          - duchy/aws-liquid-legions-v2-mill
          - duchy/aws-postgres-internal-server
          - duchy/aws-postgres-update-schema
          - duchy/aws-requisition-fulfillment
          - duchy/computation-control
          - duchy/computations-cleaner
          - duchy/gcloud-postgres-update-schema
          - duchy/herald
          - duchy/honest-majority-share-shuffle-mill
          - duchy/liquid-legions-v2-mill
          - duchy/mill-job-scheduler
          - duchy/postgres-internal-server
          - duchy/postgres-update-schema
          - duchy/requisition-fulfillment
          - duchy/spanner-computations
          - duchy/spanner-update-schema
          - duchy/trus-tee-mill
          - edp-aggregator/internal-api
          - edp-aggregator/results_fulfiller
          - edp-aggregator/system-api
          - edp-aggregator/update-schema
          - kingdom/bigquery-operational-metrics
          - kingdom/completed-measurements-deletion
          - kingdom/data-server
          - kingdom/exchanges-deletion
          - kingdom/pending-measurements-cancellation
          - kingdom/spanner-update-schema
          - kingdom/system-api
          - kingdom/v2alpha-public-api
          - loadtest/panel-match-resource-setup
          - loadtest/resource-setup
          - panel-exchange/aws-example-daemon
          - panel-exchange/forwarded-storage-daemon
          - panel-exchange/gcloud-example-daemon
          - prober/measurement-system-prober
          - reporting/grpc-gateway
          - reporting/v2/basic-reports-reports
          - reporting/v2/gcloud-internal-server
          - reporting/v2/gcloud-postgres-update-schema
          - reporting/v2/report-result-post-processor
          - reporting/v2/report-scheduling
          - reporting/v2/spanner-update-schema
          - reporting/v2/v2alpha-public-api
          - secure-computation/internal-server
          - secure-computation/public-api
          - secure-computation/update-schema
          - simulator/edp
          - simulator/legacy-metadata-edp
    steps:
      - name: Get SARIF file path
        id: get-sarif-file-path
        env:
          IMAGE: ${{ matrix.image }}
        run:
          echo "path=${IMAGE//\//_}.sarif" >> $GITHUB_OUTPUT
      - name: Run Trivy image scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        env:
          TRIVY_SKIP_DB_UPDATE: true
          TRIVY_SKIP_JAVA_DB_UPDATE: true
        with:
          image-ref: ${{ inputs.container-registry }}/${{ inputs.image-repo-prefix }}/${{ matrix.image }}:${{ inputs.image-tag }}
          format: sarif
          output: ${{ steps.get-sarif-file-path.outputs.path }}
      - name: Upload scan results to GitHub
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: ${{ steps.get-sarif-file-path.outputs.path }}
          category: trivy-${{ matrix.image }}
