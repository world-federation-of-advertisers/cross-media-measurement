name: Certificates and Keys

on:
  push:
    branches: [ "feature/create_k8s_manifest_kingdom" ]

jobs:
  generate-certs-secrets:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: make directory to strore the certs and keys
        run: |
          mkdir test-certs

      - name: Generate certificates and keys
        working-directory: test-certs
        run: |
          openssl genrsa -out ca.key 2048
          openssl req -new -key ca.key -subj "/CN=kubernetes-ca" -out ca.csr
          openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt

          openssl genrsa -out worker1_tls.key 2048
          openssl req -new -key worker1_tls.key -subj "/CN=kubernetes" -out worker1_tls.csr
          openssl x509 -req -in worker1_tls.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out worker1_tls.crt -days 365

          openssl genrsa -out worker1.key 2048
          openssl req -new -key worker1.key -subj "/CN=kubernetes-worker1" -out worker1.csr
          openssl x509 -req -in worker1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out worker1.crt -days 365
          openssl x509 -in worker1.crt -outform der -out worker1_cs_cert.der
          
          openssl genrsa -out worker1_cs_private.key 2048
          openssl req -new -key worker1_cs_private.key -subj "/CN=kubernetes-worker1" -out worker1_cs_private.csr
          openssl x509 -req -in worker1.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out worker1.crt -days 365
          openssl x509 -in worker1.crt -outform der -out worker1_cs_private.der

      - name: checking the files in directory
        run: | 
          ls test-certs

      - name: Create secret
        run: |
          kubectl create secret generic kubernetes-certs \
          --from-file=ca.crt=ca.crt \
          --from-file=worker1_tls.crt=worker1_tls.crt \
          --from-file=worker1_tls.key=worker1_tls.key \
          --from-file=worker1.crt=worker1.crt \
          --from-file=worker1.key=worker1.key \
          --namespace=default
