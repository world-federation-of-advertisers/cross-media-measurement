# Copyright 2025 The Cross-Media Measurement Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Computes the difference in detected vulnerabilities between two Git references: {target-ref} - {base-ref}.
name: Compute vulnerabilities diff

on:
  workflow_dispatch:
    inputs:
      base-ref:
        type: string
        description: "The fully qualified Git reference for which to get the base scan."
        required: true
      target-ref:
        type: string
        description: "The fully qualified Git reference for which to get the target scan."
        required: true
  #DO_NOT_SUBMIT: remove pull_request event
  pull_request:

permissions:
  contents: read

jobs:
  compute-vuln-diff:
    name: Compute vulnerabilities diff
    runs-on: ubuntu-22.04
    permissions:
      security-events: read
    outputs:
      summary: ${{ steps.generate-release-notes.outputs.summary }}
    steps:
      - name: Check out revision
        uses: actions/checkout@v4

      - uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Compute vulnerabilities diff
        id: compute-vulnerabilities-diff
        env:
          GH_TOKEN: ${{ github.token }}
          #DO_NOT_SUBMIT: restore parameter usage
          #BASE_REF: ${{ inputs.base-ref }}
          #TARGET_REF: ${{ inputs.target-ref }}
          BASE_REF: "refs/tags/v0.5.28"
          TARGET_REF: "refs/tags/nightly/20251205.1"
        run: >
          python .github/workflows/scripts/scanning-alerts/compute-vulnerabilities-diff.py 
          --base_ref "${BASE_REF}"
          --target_ref "${TARGET_REF}"

      - name: Print report
        env:
          JSON: ${{ steps.compute-vulnerabilities-diff.outputs.json }}
        run: |
          jq -r .[] <<< "${JSON}"