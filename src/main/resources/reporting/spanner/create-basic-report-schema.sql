-- liquibase formatted sql

-- Copyright 2025 The Cross-Media Measurement Authors
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

-- changeset tristanvuong2021:1 dbms:cloudspanner
-- comment: Create the initial basic report tables

-- Set protobuf FileDescriptorSet as a base64 string. This gets applied to the next DDL batch.
SET PROTO_DESCRIPTORS = 'CtABChZnb29nbGUvdHlwZS9kYXRlLnByb3RvEgtnb29nbGUudHlwZSJCCgREYXRlEhIKBHllYXIYASABKAVSBHllYXISFAoFbW9udGgYAiABKAVSBW1vbnRoEhAKA2RheRgDIAEoBVIDZGF5Ql0KD2NvbS5nb29nbGUudHlwZUIJRGF0ZVByb3RvUAFaNGdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvL2dvb2dsZWFwaXMvdHlwZS9kYXRlO2RhdGX4AQGiAgNHVFBiBnByb3RvMwr7AQoeZ29vZ2xlL3Byb3RvYnVmL2R1cmF0aW9uLnByb3RvEg9nb29nbGUucHJvdG9idWYiOgoIRHVyYXRpb24SGAoHc2Vjb25kcxgBIAEoA1IHc2Vjb25kcxIUCgVuYW5vcxgCIAEoBVIFbmFub3NCgwEKE2NvbS5nb29nbGUucHJvdG9idWZCDUR1cmF0aW9uUHJvdG9QAVoxZ29vZ2xlLmdvbGFuZy5vcmcvcHJvdG9idWYvdHlwZXMva25vd24vZHVyYXRpb25wYvgBAaICA0dQQqoCHkdvb2dsZS5Qcm90b2J1Zi5XZWxsS25vd25UeXBlc2IGcHJvdG8zCpwEChpnb29nbGUvdHlwZS9kYXRldGltZS5wcm90bxILZ29vZ2xlLnR5cGUaHmdvb2dsZS9wcm90b2J1Zi9kdXJhdGlvbi5wcm90byKnAgoIRGF0ZVRpbWUSEgoEeWVhchgBIAEoBVIEeWVhchIUCgVtb250aBgCIAEoBVIFbW9udGgSEAoDZGF5GAMgASgFUgNkYXkSFAoFaG91cnMYBCABKAVSBWhvdXJzEhgKB21pbnV0ZXMYBSABKAVSB21pbnV0ZXMSGAoHc2Vjb25kcxgGIAEoBVIHc2Vjb25kcxIUCgVuYW5vcxgHIAEoBVIFbmFub3MSOgoKdXRjX29mZnNldBgIIAEoCzIZLmdvb2dsZS5wcm90b2J1Zi5EdXJhdGlvbkgAUgl1dGNPZmZzZXQSNAoJdGltZV96b25lGAkgASgLMhUuZ29vZ2xlLnR5cGUuVGltZVpvbmVIAFIIdGltZVpvbmVCDQoLdGltZV9vZmZzZXQiNAoIVGltZVpvbmUSDgoCaWQYASABKAlSAmlkEhgKB3ZlcnNpb24YAiABKAlSB3ZlcnNpb25CaQoPY29tLmdvb2dsZS50eXBlQg1EYXRlVGltZVByb3RvUAFaPGdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvL2dvb2dsZWFwaXMvdHlwZS9kYXRldGltZTtkYXRldGltZfgBAaICA0dUUGIGcHJvdG8zCtYCCj53ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbnRlcnZhbC5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MhoWZ29vZ2xlL3R5cGUvZGF0ZS5wcm90bxoaZ29vZ2xlL3R5cGUvZGF0ZXRpbWUucHJvdG8ifwoRUmVwb3J0aW5nSW50ZXJ2YWwSOAoMcmVwb3J0X3N0YXJ0GAEgASgLMhUuZ29vZ2xlLnR5cGUuRGF0ZVRpbWVSC3JlcG9ydFN0YXJ0EjAKCnJlcG9ydF9lbmQYAiABKAsyES5nb29nbGUudHlwZS5EYXRlUglyZXBvcnRFbmRCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCrgDCkB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2Jhc2ljX3JlcG9ydF9kZXRhaWxzLnByb3RvEiV3ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyGj53ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbnRlcnZhbC5wcm90byLSAQoSQmFzaWNSZXBvcnREZXRhaWxzEhQKBXRpdGxlGAEgASgJUgV0aXRsZRI9ChtjYW1wYWlnbl9ncm91cF9kaXNwbGF5X25hbWUYAyABKAlSGGNhbXBhaWduR3JvdXBEaXNwbGF5TmFtZRJnChJyZXBvcnRpbmdfaW50ZXJ2YWwYBCABKAsyOC53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlcG9ydGluZ0ludGVydmFsUhFyZXBvcnRpbmdJbnRlcnZhbEIwCixvcmcud2ZhbmV0Lm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MlABYgZwcm90bzMKqwMKQHdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvZXZlbnRfdGVtcGxhdGVfZmllbGQucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIihQIKEkV2ZW50VGVtcGxhdGVGaWVsZBISCgRwYXRoGAEgASgJUgRwYXRoEloKBXZhbHVlGAIgASgLMkQud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5FdmVudFRlbXBsYXRlRmllbGQuRmllbGRWYWx1ZVIFdmFsdWUafwoKRmllbGRWYWx1ZRIjCgxzdHJpbmdfdmFsdWUYASABKAlIAFILc3RyaW5nVmFsdWUSHwoKZW51bV92YWx1ZRgCIAEoCUgAUgllbnVtVmFsdWUSHwoKYm9vbF92YWx1ZRgDIAEoCEgAUglib29sVmFsdWVCCgoIc2VsZWN0b3JCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCr0CCjh3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2V2ZW50X2ZpbHRlci5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MhpAd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9ldmVudF90ZW1wbGF0ZV9maWVsZC5wcm90byJeCgtFdmVudEZpbHRlchJPCgV0ZXJtcxgBIAMoCzI5LndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuRXZlbnRUZW1wbGF0ZUZpZWxkUgV0ZXJtc0IwCixvcmcud2ZhbmV0Lm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MlABYgZwcm90bzMKoAQKUHdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvaW1wcmVzc2lvbl9xdWFsaWZpY2F0aW9uX2ZpbHRlcl9zcGVjLnByb3RvEiV3ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyGjh3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2V2ZW50X2ZpbHRlci5wcm90byKwAgohSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXJTcGVjEnEKCm1lZGlhX3R5cGUYASABKA4yUi53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVyU3BlYy5NZWRpYVR5cGVSCW1lZGlhVHlwZRJMCgdmaWx0ZXJzGAIgAygLMjIud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5FdmVudEZpbHRlclIHZmlsdGVycyJKCglNZWRpYVR5cGUSGgoWTUVESUFfVFlQRV9VTlNQRUNJRklFRBAAEgkKBVZJREVPEAESCwoHRElTUExBWRACEgkKBU9USEVSEANCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCqQCChtnb29nbGUvdHlwZS9kYXlvZndlZWsucHJvdG8SC2dvb2dsZS50eXBlKoQBCglEYXlPZldlZWsSGwoXREFZX09GX1dFRUtfVU5TUEVDSUZJRUQQABIKCgZNT05EQVkQARILCgdUVUVTREFZEAISDQoJV0VETkVTREFZEAMSDAoIVEhVUlNEQVkQBBIKCgZGUklEQVkQBRIMCghTQVRVUkRBWRAGEgoKBlNVTkRBWRAHQmkKD2NvbS5nb29nbGUudHlwZUIORGF5T2ZXZWVrUHJvdG9QAVo+Z29vZ2xlLmdvbGFuZy5vcmcvZ2VucHJvdG8vZ29vZ2xlYXBpcy90eXBlL2RheW9md2VlaztkYXlvZndlZWuiAgNHVFBiBnByb3RvMwquAgpBd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9tZXRyaWNfZnJlcXVlbmN5X3NwZWMucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIaG2dvb2dsZS90eXBlL2RheW9md2Vlay5wcm90byJrChNNZXRyaWNGcmVxdWVuY3lTcGVjEjAKBndlZWtseRgBIAEoDjIWLmdvb2dsZS50eXBlLkRheU9mV2Vla0gAUgZ3ZWVrbHkSFgoFdG90YWwYAiABKAhIAFIFdG90YWxCCgoIc2VsZWN0b3JCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCsoFClV3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbXByZXNzaW9uX3F1YWxpZmljYXRpb25fZmlsdGVyLnByb3RvEiV3ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyGlB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2ltcHJlc3Npb25fcXVhbGlmaWNhdGlvbl9maWx0ZXJfc3BlYy5wcm90byK9AwomUmVwb3J0aW5nSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXISXgorZXh0ZXJuYWxfaW1wcmVzc2lvbl9xdWFsaWZpY2F0aW9uX2ZpbHRlcl9pZBgBIAEoCUgAUidleHRlcm5hbEltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVySWQSjwEKBmN1c3RvbRgCIAEoCzJ1LndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVwb3J0aW5nSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXIuQ3VzdG9tSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXJTcGVjSABSBmN1c3RvbRqUAQonQ3VzdG9tSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXJTcGVjEmkKC2ZpbHRlcl9zcGVjGAEgAygLMkgud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5JbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlclNwZWNSCmZpbHRlclNwZWNCCgoIc2VsZWN0b3JCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCv8BCh9nb29nbGUvcHJvdG9idWYvdGltZXN0YW1wLnByb3RvEg9nb29nbGUucHJvdG9idWYiOwoJVGltZXN0YW1wEhgKB3NlY29uZHMYASABKANSB3NlY29uZHMSFAoFbmFub3MYAiABKAVSBW5hbm9zQoUBChNjb20uZ29vZ2xlLnByb3RvYnVmQg5UaW1lc3RhbXBQcm90b1ABWjJnb29nbGUuZ29sYW5nLm9yZy9wcm90b2J1Zi90eXBlcy9rbm93bi90aW1lc3RhbXBwYvgBAaICA0dQQqoCHkdvb2dsZS5Qcm90b2J1Zi5XZWxsS25vd25UeXBlc2IGcHJvdG8zCrsCChpnb29nbGUvdHlwZS9pbnRlcnZhbC5wcm90bxILZ29vZ2xlLnR5cGUaH2dvb2dsZS9wcm90b2J1Zi90aW1lc3RhbXAucHJvdG8ifAoISW50ZXJ2YWwSOQoKc3RhcnRfdGltZRgBIAEoCzIaLmdvb2dsZS5wcm90b2J1Zi5UaW1lc3RhbXBSCXN0YXJ0VGltZRI1CghlbmRfdGltZRgCIAEoCzIaLmdvb2dsZS5wcm90b2J1Zi5UaW1lc3RhbXBSB2VuZFRpbWVCaQoPY29tLmdvb2dsZS50eXBlQg1JbnRlcnZhbFByb3RvUAFaPGdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvL2dvb2dsZWFwaXMvdHlwZS9pbnRlcnZhbDtpbnRlcnZhbPgBAaICA0dUUGIGcHJvdG8zCrAmCjB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3BhZ2UucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIaGmdvb2dsZS90eXBlL2ludGVydmFsLnByb3RvGjh3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2V2ZW50X2ZpbHRlci5wcm90bxpAd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9ldmVudF90ZW1wbGF0ZV9maWVsZC5wcm90bxpBd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9tZXRyaWNfZnJlcXVlbmN5X3NwZWMucHJvdG8aVXdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvcmVwb3J0aW5nX2ltcHJlc3Npb25fcXVhbGlmaWNhdGlvbl9maWx0ZXIucHJvdG8ikwEKE0V4dGVybmFsQ29tcG9uZW50SWQSOwoZZXh0ZXJuYWxfcmVwb3J0aW5nX3NldF9pZBgBIAEoCUgAUhZleHRlcm5hbFJlcG9ydGluZ1NldElkEjMKFWNtbXNfZGF0YV9wcm92aWRlcl9pZBgCIAEoCUgAUhJjbW1zRGF0YVByb3ZpZGVySWRCCgoIcmVzb3VyY2Ui0iEKBFBhZ2USFAoFdGl0bGUYASABKAlSBXRpdGxlEkwKB3Jlc3VsdHMYAiADKAsyMi53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlBhZ2UuUmVzdWx0UgdyZXN1bHRzGqkRCg5NZXRyaWNNZXRhZGF0YRKFAQoWcmVwb3J0aW5nX3VuaXRfc3VtbWFyeRgBIAEoCzJPLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUGFnZS5NZXRyaWNNZXRhZGF0YS5SZXBvcnRpbmdVbml0U3VtbWFyeVIUcmVwb3J0aW5nVW5pdFN1bW1hcnkSZQoGZmlsdGVyGAIgASgLMk0ud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5SZXBvcnRpbmdJbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlclIGZmlsdGVyEmoKB2RldGFpbHMYAyABKAsyUC53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlBhZ2UuTWV0cmljTWV0YWRhdGEuTWV0cmljTWV0YWRhdGFEZXRhaWxzUgdkZXRhaWxzGsIFCh1SZXBvcnRpbmdVbml0Q29tcG9uZW50U3VtbWFyeRJuChVleHRlcm5hbF9jb21wb25lbnRfaWQYASABKAsyOi53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkV4dGVybmFsQ29tcG9uZW50SWRSE2V4dGVybmFsQ29tcG9uZW50SWQSlwEKB2RldGFpbHMYAiABKAsyfS53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlBhZ2UuTWV0cmljTWV0YWRhdGEuUmVwb3J0aW5nVW5pdENvbXBvbmVudFN1bW1hcnkuUmVwb3J0aW5nVW5pdENvbXBvbmVudFN1bW1hcnlEZXRhaWxzUgdkZXRhaWxzGpYDCiRSZXBvcnRpbmdVbml0Q29tcG9uZW50U3VtbWFyeURldGFpbHMSIQoMZGlzcG';

START BATCH DDL;

-- Create the initial proto bundle with all types defined in the FileDescriptorSet.
CREATE PROTO BUNDLE (
  `wfa.measurement.internal.reporting.v2.BasicReportDetails`,
  `wfa.measurement.internal.reporting.v2.ReportingImpressionQualificationFilter.CustomImpressionQualificationFilterSpec`,
  `wfa.measurement.internal.reporting.v2.ImpressionQualificationFilterSpec`,
  `wfa.measurement.internal.reporting.v2.EventFilter`,
  `wfa.measurement.internal.reporting.v2.EventTemplateField`,
  `wfa.measurement.internal.reporting.v2.ReportingInterval`,
  `wfa.measurement.internal.reporting.v2.Page`,
  `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.ReportingUnitComponentSummary.ReportingUnitComponentSummaryDetails`,
  `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.ReportingUnitComponentSummary.ReportingUnitComponentSummaryDetails.EventGroupSummary`,
  `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.MetricMetadataDetails`,
  `wfa.measurement.internal.reporting.v2.MetricFrequencySpec`,
  `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.MetricMetadataDetails.WindowingSpec`,
  `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.MetricMetadataDetails.DimensionSpecSummary`,
  `wfa.measurement.internal.reporting.v2.Page.MetricSet.BasicMetricSet`,
  `wfa.measurement.internal.reporting.v2.Page.MetricSet.ComponentMetricSet`,
  `wfa.measurement.internal.reporting.v2.Page.MetricSet.ComponentIntersectionMetricSet.ComponentIntersectionMetricSetDetails`,
  `wfa.measurement.internal.reporting.v2.Page.MetricSet.MetricSetDetails`,
  `wfa.measurement.internal.reporting.v2.Page.MetricSet.MetricSetDetails.ReportingUnitMetricSet`,
);

CREATE TABLE ReportingSets (
  ReportingSetId INT64 NOT NULL,
  CmmsMeasurementConsumerId STRING(MAX) NOT NULL,
  ExternalReportingSetId STRING(MAX) NOT NULL
) PRIMARY KEY ReportingSetId);

CREATE TABLE BasicReports (
  BasicReportId INT64 NOT NULL,
  CmmsMeasurementConsumerId STRING(MAX) NOT NULL,
  ExternalBasicReportId STRING(MAX) NOT NULL,
  RequestId STRING(MAX),
  CreateTime TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp = true),
  BasicReportDetails `wfa.measurement.internal.reporting.v2.BasicReportDetails`
    NOT NULL,
  CampaignGroupId STRING(MAX) NOT NULL,

  CONSTRAINT FK_BasicReportsReportingSets FOREIGN KEY CampaignGroupId REFERENCES ReportingSets(ReportingSetId)
) PRIMARY KEY (BasicReportId);

CREATE UNIQUE INDEX BasicReportsByExternalBasicReportId
  ON BasicReports(CmmsMeasurementConsumerId, ExternalBasicReportId);

CREATE INDEX BasicReportsByCreateTime
  ON BasicReports(CmmsMeasurementConsumerId, CreateTime, ExternalBasicReportId);

CREATE TABLE ReportingImpressionQualificationFilter (
  BasicReportId NOT NULL,
  ReportingImpressionQualificationFilter INT64 NOT NULL,

  ExternalImpressionQualificationFilterId STRING(MAX),
  CustomImpressionQualificationFilterSpec `wfa.measurement.internal.reporting.v2.ReportingImpressionQualificationFilter.CustomImpressionQualificationFilterSpec`,

  CONSTRAINT FK_ReportingImpressionQualificationFiltersBasicReports FOREIGN KEY BasicReportId REFERENCES BasicReports(BasicReportId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, ReportingImpressionQualificationFilterId);

CREATE TABLE Pages (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,

  Title STRING(MAX),

  CONSTRAINT FK_PagesBasicReports FOREIGN KEY BasicReportId REFERENCES BasicReports(BasicReportId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId);

CREATE TABLE Results (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,

  CONSTRAINT FK_ResultsPages FOREIGN KEY (BasicReportId, PageId) REFERENCES Pages(BasicReportId, PageId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId);

CREATE TABLE MetricMetadata (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricMetadataId INT64 NOT NULL,

  ReportingImpressionQualificationFilterId INT64 NOT NULL,
  MetricMetadataDetails `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.MetricMetadataDetails`
    NOT NULL,

  CONSTRAINT FK_MetricMetadataReportingImpressionQualificationFilters FOREIGN KEY (BasicReportId, ReportingImpressionQualificationFilterId)
    REFERENCES ReportingImpressionQualificationFilters(BasicReportId, ReportingImpressionQualificationFilterId),
  CONSTRAINT FK_MetricMetadataResults FOREIGN KEY (BasicReportId, PageId, ResultId) REFERENCES Results(BasicReportId, PageId, ResultId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricMetadataId);

CREATE TABLE ReportingUnitSummaries (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricMetadataId INT64 NOT NULL,
  ReportingUnitSummaryId INT64 NOT NULL,

  CONSTRAINT FK_ReportingUnitSummariesMetricMetadata FOREIGN KEY (BasicReportId, PageId, ResultId, MetricMetadataId)
    REFERENCES MetricMetadata(BasicReportId, PageId, ResultId, MetricMetadataId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricMetadataId, ReportingUnitSummaryId);

CREATE TABLE ReportingUnitComponentSummaries (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricMetadataId INT64 NOT NULL,
  ReportingUnitSummaryId INT64 NOT NULL,
  ReportingUnitComponentSummaryId INT64 NOT NULL,

  ReportingSetId INT64,
  CmmsDataProviderId STRING(MAX),
  ReportingUnitComponentSummaryDetails `wfa.measurement.internal.reporting.v2.Page.MetricMetadata.ReportingUnitComponentSummary.ReportingUnitComponentSummaryDetails`
    NOT NULL,

  CONSTRAINT FK_ReportingUnitComponentSummariesReportingSets FOREIGN KEY ReportingSetId REFERENCES ReportingSets(ReportingSetId),
  CONSTRAINT FK_ReportingUnitComponentSummariesReportingUnitSummaries FOREIGN KEY (BasicReportId, PageId, ResultId, MetricMetadataId)
    REFERENCES ReportingUnitSummaries(BasicReportId, PageId, ResultId, MetricMetadataId, ReportingUnitSummaryId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricMetadataId, ReportingUnitSummaryId, ReportingUnitComponentSummaryId);

CREATE TABLE MetricSets (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricSetId INT64 NOT NULL,

  MetricSetDetails `wfa.measurement.internal.reporting.v2.Page.MetricSet.MetricSetDetails` NOT NULL,

  CONSTRAINT FK_MetricSetsResults FOREIGN KEY (BasicReportId, PageId, ResultId) REFERENCES Results(BasicReportId, PageId, ResultId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricSetId);

CREATE TABLE ComponentMetricSetMapEntries (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricSetId INT64 NOT NULL,
  ComponentMetricSetMapEntryId NOT NULL,

  ReportingSetId INT64,
  CmmsDataProviderId STRING(MAX),
  ComponentMetricSet `wfa.measurement.internal.reporting.v2.Page.MetricSet.ComponentMetricSet` NOT NULL,

  CONSTRAINT FK_ComponentMetricSetMapEntriesReportingSets FOREIGN KEY ReportingSetId REFERENCES ReportingSets(ReportingSetId),
  CONSTRAINT FK_ComponentMetricSetMapEntriesMetricSets FOREIGN KEY (BasicReportId, PageId, ResultId, MetricSetId)
    REFERENCES MetricSets(BasicReportId, PageId, ResultId, MetricSetId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricSetId, ComponentMetricSetMapEntryId);

CREATE TABLE ComponentIntersectionMetricSets (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricSetId INT64 NOT NULL,
  ComponentIntersectionMetricSetId NOT NULL,

  ComponentIntersectionMetricSetDetails `wfa.measurement.internal.reporting.v2.Page.MetricSet.ComponentIntersectionMetricSet.ComponentIntersectionMetricSetDetails`
   NOT NULL,

  CONSTRAINT FK_ComponentIntersectionMetricSetsReportingSets FOREIGN KEY ReportingSetId REFERENCES ReportingSets(ReportingSetId),
  CONSTRAINT FK_ComponentIntersectionMetricSetsMetricSets FOREIGN KEY (BasicReportId, PageId, ResultId, MetricSetId)
    REFERENCES MetricSets(BasicReportId, PageId, ResultId, MetricSetId) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricSetId, ComponentIntersectionMetricSetId);

CREATE TABLE ComponentIntersectionMetricSetReportingSets (
  BasicReportId NOT NULL,
  PageId INT64 NOT NULL,
  ResultId INT64 NOT NULL,
  MetricSetId INT64 NOT NULL,
  ComponentIntersectionMetricSetId NOT NULL,
  ReportingSetId NOT NULL,

  CONSTRAINT FK_ComponentIntersectionMetricSetReportingSetsReportingSets FOREIGN KEY ReportingSetId REFERENCES ReportingSets(ReportingSetId),
  CONSTRAINT FK_ComponentIntersectionMetricSetReportingSetsComponentIntersectionMetricSets
    FOREIGN KEY (BasicReportId, PageId, ResultId, MetricSetId, ComponentIntersectionMetricSetId)
    REFERENCES ComponentIntersectionMetricSets(BasicReportId, PageId, ResultId, MetricSetId, ComponentIntersectionMetricSets) ON DELETE CASCADE
) PRIMARY KEY (BasicReportId, PageId, ResultId, MetricSetId, ComponentIntersectionMetricSetId, ReportingSetId);

RUN BATCH;
