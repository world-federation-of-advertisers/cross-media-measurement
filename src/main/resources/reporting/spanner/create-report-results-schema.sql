-- liquibase formatted sql

-- Copyright 2025 The Cross-Media Measurement Authors
--
-- Licensed under the Apache License, Version 2.0 (the "License");
-- you may not use this file except in compliance with the License.
-- You may obtain a copy of the License at
--
--     http://www.apache.org/licenses/LICENSE-2.0
--
-- Unless required by applicable law or agreed to in writing, software
-- distributed under the License is distributed on an "AS IS" BASIS,
-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-- See the License for the specific language governing permissions and
-- limitations under the License.

-- changeset tristanvuong2021:4 dbms:cloudspanner
-- comment: Create ReportResults tables and make them usable for BasicReport

-- Set protobuf FileDescriptorSet as a base64 string. This gets applied to the next DDL batch.
SET PROTO_DESCRIPTORS = 'Cs8DCkB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2V2ZW50X3RlbXBsYXRlX2ZpZWxkLnByb3RvEiV3ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyIqkCChJFdmVudFRlbXBsYXRlRmllbGQSEgoEcGF0aBgBIAEoCVIEcGF0aBJaCgV2YWx1ZRgCIAEoCzJELndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuRXZlbnRUZW1wbGF0ZUZpZWxkLkZpZWxkVmFsdWVSBXZhbHVlGqIBCgpGaWVsZFZhbHVlEiMKDHN0cmluZ192YWx1ZRgBIAEoCUgAUgtzdHJpbmdWYWx1ZRIfCgplbnVtX3ZhbHVlGAIgASgJSABSCWVudW1WYWx1ZRIfCgpib29sX3ZhbHVlGAMgASgISABSCWJvb2xWYWx1ZRIhCgtmbG9hdF92YWx1ZRgEIAEoAkgAUgpmbG9hdFZhbHVlQgoKCHNlbGVjdG9yQjAKLG9yZy53ZmFuZXQubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyUAFiBnByb3RvMwq9Ago4d2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9ldmVudF9maWx0ZXIucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIaQHdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvZXZlbnRfdGVtcGxhdGVfZmllbGQucHJvdG8iXgoLRXZlbnRGaWx0ZXISTwoFdGVybXMYASADKAsyOS53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkV2ZW50VGVtcGxhdGVGaWVsZFIFdGVybXNCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCqAEClB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2ltcHJlc3Npb25fcXVhbGlmaWNhdGlvbl9maWx0ZXJfc3BlYy5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mho4d2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9ldmVudF9maWx0ZXIucHJvdG8isAIKIUltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVyU3BlYxJxCgptZWRpYV90eXBlGAEgASgOMlIud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5JbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlclNwZWMuTWVkaWFUeXBlUgltZWRpYVR5cGUSTAoHZmlsdGVycxgCIAMoCzIyLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuRXZlbnRGaWx0ZXJSB2ZpbHRlcnMiSgoJTWVkaWFUeXBlEhoKFk1FRElBX1RZUEVfVU5TUEVDSUZJRUQQABIJCgVWSURFTxABEgsKB0RJU1BMQVkQAhIJCgVPVEhFUhADQjAKLG9yZy53ZmFuZXQubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyUAFiBnByb3RvMwqABApVd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9yZXBvcnRpbmdfaW1wcmVzc2lvbl9xdWFsaWZpY2F0aW9uX2ZpbHRlci5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MhpQd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9pbXByZXNzaW9uX3F1YWxpZmljYXRpb25fZmlsdGVyX3NwZWMucHJvdG8i8wEKJlJlcG9ydGluZ0ltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVyElwKK2V4dGVybmFsX2ltcHJlc3Npb25fcXVhbGlmaWNhdGlvbl9maWx0ZXJfaWQYASABKAlSJ2V4dGVybmFsSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXJJZBJrCgxmaWx0ZXJfc3BlY3MYAiADKAsySC53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVyU3BlY1ILZmlsdGVyU3BlY3NCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCtABChZnb29nbGUvdHlwZS9kYXRlLnByb3RvEgtnb29nbGUudHlwZSJCCgREYXRlEhIKBHllYXIYASABKAVSBHllYXISFAoFbW9udGgYAiABKAVSBW1vbnRoEhAKA2RheRgDIAEoBVIDZGF5Ql0KD2NvbS5nb29nbGUudHlwZUIJRGF0ZVByb3RvUAFaNGdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvL2dvb2dsZWFwaXMvdHlwZS9kYXRlO2RhdGX4AQGiAgNHVFBiBnByb3RvMwr7AQoeZ29vZ2xlL3Byb3RvYnVmL2R1cmF0aW9uLnByb3RvEg9nb29nbGUucHJvdG9idWYiOgoIRHVyYXRpb24SGAoHc2Vjb25kcxgBIAEoA1IHc2Vjb25kcxIUCgVuYW5vcxgCIAEoBVIFbmFub3NCgwEKE2NvbS5nb29nbGUucHJvdG9idWZCDUR1cmF0aW9uUHJvdG9QAVoxZ29vZ2xlLmdvbGFuZy5vcmcvcHJvdG9idWYvdHlwZXMva25vd24vZHVyYXRpb25wYvgBAaICA0dQQqoCHkdvb2dsZS5Qcm90b2J1Zi5XZWxsS25vd25UeXBlc2IGcHJvdG8zCpwEChpnb29nbGUvdHlwZS9kYXRldGltZS5wcm90bxILZ29vZ2xlLnR5cGUaHmdvb2dsZS9wcm90b2J1Zi9kdXJhdGlvbi5wcm90byKnAgoIRGF0ZVRpbWUSEgoEeWVhchgBIAEoBVIEeWVhchIUCgVtb250aBgCIAEoBVIFbW9udGgSEAoDZGF5GAMgASgFUgNkYXkSFAoFaG91cnMYBCABKAVSBWhvdXJzEhgKB21pbnV0ZXMYBSABKAVSB21pbnV0ZXMSGAoHc2Vjb25kcxgGIAEoBVIHc2Vjb25kcxIUCgVuYW5vcxgHIAEoBVIFbmFub3MSOgoKdXRjX29mZnNldBgIIAEoCzIZLmdvb2dsZS5wcm90b2J1Zi5EdXJhdGlvbkgAUgl1dGNPZmZzZXQSNAoJdGltZV96b25lGAkgASgLMhUuZ29vZ2xlLnR5cGUuVGltZVpvbmVIAFIIdGltZVpvbmVCDQoLdGltZV9vZmZzZXQiNAoIVGltZVpvbmUSDgoCaWQYASABKAlSAmlkEhgKB3ZlcnNpb24YAiABKAlSB3ZlcnNpb25CaQoPY29tLmdvb2dsZS50eXBlQg1EYXRlVGltZVByb3RvUAFaPGdvb2dsZS5nb2xhbmcub3JnL2dlbnByb3RvL2dvb2dsZWFwaXMvdHlwZS9kYXRldGltZTtkYXRldGltZfgBAaICA0dUUGIGcHJvdG8zCtYCCj53ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbnRlcnZhbC5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MhoWZ29vZ2xlL3R5cGUvZGF0ZS5wcm90bxoaZ29vZ2xlL3R5cGUvZGF0ZXRpbWUucHJvdG8ifwoRUmVwb3J0aW5nSW50ZXJ2YWwSOAoMcmVwb3J0X3N0YXJ0GAEgASgLMhUuZ29vZ2xlLnR5cGUuRGF0ZVRpbWVSC3JlcG9ydFN0YXJ0EjAKCnJlcG9ydF9lbmQYAiABKAsyES5nb29nbGUudHlwZS5EYXRlUglyZXBvcnRFbmRCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCuoECkB3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2Jhc2ljX3JlcG9ydF9kZXRhaWxzLnByb3RvEiV3ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyGlV3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbXByZXNzaW9uX3F1YWxpZmljYXRpb25fZmlsdGVyLnByb3RvGj53ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbnRlcnZhbC5wcm90byKtAgoSQmFzaWNSZXBvcnREZXRhaWxzEhQKBXRpdGxlGAEgASgJUgV0aXRsZRKXAQogaW1wcmVzc2lvbl9xdWFsaWZpY2F0aW9uX2ZpbHRlcnMYAiADKAsyTS53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlcG9ydGluZ0ltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVyUh5pbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlcnMSZwoScmVwb3J0aW5nX2ludGVydmFsGAMgASgLMjgud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5SZXBvcnRpbmdJbnRlcnZhbFIRcmVwb3J0aW5nSW50ZXJ2YWxCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCqQCChtnb29nbGUvdHlwZS9kYXlvZndlZWsucHJvdG8SC2dvb2dsZS50eXBlKoQBCglEYXlPZldlZWsSGwoXREFZX09GX1dFRUtfVU5TUEVDSUZJRUQQABIKCgZNT05EQVkQARILCgdUVUVTREFZEAISDQoJV0VETkVTREFZEAMSDAoIVEhVUlNEQVkQBBIKCgZGUklEQVkQBRIMCghTQVRVUkRBWRAGEgoKBlNVTkRBWRAHQmkKD2NvbS5nb29nbGUudHlwZUIORGF5T2ZXZWVrUHJvdG9QAVo+Z29vZ2xlLmdvbGFuZy5vcmcvZ2VucHJvdG8vZ29vZ2xlYXBpcy90eXBlL2RheW9md2VlaztkYXlvZndlZWuiAgNHVFBiBnByb3RvMwquAgpBd2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9tZXRyaWNfZnJlcXVlbmN5X3NwZWMucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIaG2dvb2dsZS90eXBlL2RheW9md2Vlay5wcm90byJrChNNZXRyaWNGcmVxdWVuY3lTcGVjEjAKBndlZWtseRgBIAEoDjIWLmdvb2dsZS50eXBlLkRheU9mV2Vla0gAUgZ3ZWVrbHkSFgoFdG90YWwYAiABKAhIAFIFdG90YWxCCgoIc2VsZWN0b3JCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCv8BCh9nb29nbGUvcHJvdG9idWYvdGltZXN0YW1wLnByb3RvEg9nb29nbGUucHJvdG9idWYiOwoJVGltZXN0YW1wEhgKB3NlY29uZHMYASABKANSB3NlY29uZHMSFAoFbmFub3MYAiABKAVSBW5hbm9zQoUBChNjb20uZ29vZ2xlLnByb3RvYnVmQg5UaW1lc3RhbXBQcm90b1ABWjJnb29nbGUuZ29sYW5nLm9yZy9wcm90b2J1Zi90eXBlcy9rbm93bi90aW1lc3RhbXBwYvgBAaICA0dQQqoCHkdvb2dsZS5Qcm90b2J1Zi5XZWxsS25vd25UeXBlc2IGcHJvdG8zCpQjCjh3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3Jlc3VsdF9ncm91cC5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MhofZ29vZ2xlL3Byb3RvYnVmL3RpbWVzdGFtcC5wcm90bxo4d2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9ldmVudF9maWx0ZXIucHJvdG8aQHdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvZXZlbnRfdGVtcGxhdGVfZmllbGQucHJvdG8aQXdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvbWV0cmljX2ZyZXF1ZW5jeV9zcGVjLnByb3RvGlV3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL3JlcG9ydGluZ19pbXByZXNzaW9uX3F1YWxpZmljYXRpb25fZmlsdGVyLnByb3RvIr8fCgtSZXN1bHRHcm91cBIUCgV0aXRsZRgBIAEoCVIFdGl0bGUSUwoHcmVzdWx0cxgCIAMoCzI5LndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuUmVzdWx0UgdyZXN1bHRzGtcMCg5NZXRyaWNNZXRhZGF0YRKMAQoWcmVwb3J0aW5nX3VuaXRfc3VtbWFyeRgBIAEoCzJWLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljTWV0YWRhdGEuUmVwb3J0aW5nVW5pdFN1bW1hcnlSFHJlcG9ydGluZ1VuaXRTdW1tYXJ5EmIKIG5vbl9jdW11bGF0aXZlX21ldHJpY19zdGFydF90aW1lGAIgASgLMhouZ29vZ2xlLnByb3RvYnVmLlRpbWVzdGFtcFIcbm9uQ3VtdWxhdGl2ZU1ldHJpY1N0YXJ0VGltZRJbChxjdW11bGF0aXZlX21ldHJpY19zdGFydF90aW1lGAMgASgLMhouZ29vZ2xlLnByb3RvYnVmLlRpbWVzdGFtcFIZY3VtdWxhdGl2ZU1ldHJpY1N0YXJ0VGltZRJCCg9tZXRyaWNfZW5kX3RpbWUYBCABKAsyGi5nb29nbGUucHJvdG9idWYuVGltZXN0YW1wUg1tZXRyaWNFbmRUaW1lEm4KFW1ldHJpY19mcmVxdWVuY3lfc3BlYxgFIAEoCzI6LndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuTWV0cmljRnJlcXVlbmN5U3BlY1ITbWV0cmljRnJlcXVlbmN5U3BlYxKMAQoWZGltZW5zaW9uX3NwZWNfc3VtbWFyeRgGIAEoCzJWLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljTWV0YWRhdGEuRGltZW5zaW9uU3BlY1N1bW1hcnlSFGRpbWVuc2lvblNwZWNTdW1tYXJ5EmUKBmZpbHRlchgHIAEoCzJNLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVwb3J0aW5nSW1wcmVzc2lvblF1YWxpZmljYXRpb25GaWx0ZXJSBmZpbHRlchrGAwodUmVwb3J0aW5nVW5pdENvbXBvbmVudFN1bW1hcnkSMQoVY21tc19kYXRhX3Byb3ZpZGVyX2lkGAEgASgJUhJjbW1zRGF0YVByb3ZpZGVySWQSRAofY21tc19kYXRhX3Byb3ZpZGVyX2Rpc3BsYXlfbmFtZRgCIAEoCVIbY21tc0RhdGFQcm92aWRlckRpc3BsYXlOYW1lEqUBChVldmVudF9ncm91cF9zdW1tYXJpZXMYAyADKAsycS53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY01ldGFkYXRhLlJlcG9ydGluZ1VuaXRDb21wb25lbnRTdW1tYXJ5LkV2ZW50R3JvdXBTdW1tYXJ5UhNldmVudEdyb3VwU3VtbWFyaWVzGoMBChFFdmVudEdyb3VwU3VtbWFyeRI/ChxjbW1zX21lYXN1cmVtZW50X2NvbnN1bWVyX2lkGAEgASgJUhljbW1zTWVhc3VyZW1lbnRDb25zdW1lcklkEi0KE2NtbXNfZXZlbnRfZ3JvdXBfaWQYAiABKAlSEGNtbXNFdmVudEdyb3VwSWQawQEKFFJlcG9ydGluZ1VuaXRTdW1tYXJ5EqgBCiByZXBvcnRpbmdfdW5pdF9jb21wb25lbnRfc3VtbWFyeRgBIAMoCzJfLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljTWV0YWRhdGEuUmVwb3J0aW5nVW5pdENvbXBvbmVudFN1bW1hcnlSHXJlcG9ydGluZ1VuaXRDb21wb25lbnRTdW1tYXJ5Gr0BChREaW1lbnNpb25TcGVjU3VtbWFyeRJXCglncm91cGluZ3MYASADKAsyOS53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkV2ZW50VGVtcGxhdGVGaWVsZFIJZ3JvdXBpbmdzEkwKB2ZpbHRlcnMYAiADKAsyMi53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLkV2ZW50RmlsdGVyUgdmaWx0ZXJzGqMQCglNZXRyaWNTZXQSJwoPcG9wdWxhdGlvbl9zaXplGAEgASgFUg5wb3B1bGF0aW9uU2l6ZRJ6Cg5yZXBvcnRpbmdfdW5pdBgCIAEoCzJTLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0LlJlcG9ydGluZ1VuaXRNZXRyaWNTZXRSDXJlcG9ydGluZ1VuaXQSgwEKCmNvbXBvbmVudHMYAyADKAsyYy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5EYXRhUHJvdmlkZXJDb21wb25lbnRNZXRyaWNTZXRNYXBFbnRyeVIKY29tcG9uZW50cxKgAQoXY29tcG9uZW50X2ludGVyc2VjdGlvbnMYBCADKAsyZy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5EYXRhUHJvdmlkZXJDb21wb25lbnRJbnRlcnNlY3Rpb25NZXRyaWNTZXRSFmNvbXBvbmVudEludGVyc2VjdGlvbnMagQIKDkJhc2ljTWV0cmljU2V0EhQKBXJlYWNoGAEgASgFUgVyZWFjaBIjCg1wZXJjZW50X3JlYWNoGAIgASgCUgxwZXJjZW50UmVhY2gSIAoMa19wbHVzX3JlYWNoGAMgAygFUgprUGx1c1JlYWNoEi8KFHBlcmNlbnRfa19wbHVzX3JlYWNoGAQgAygCUhFwZXJjZW50S1BsdXNSZWFjaBIrChFhdmVyYWdlX2ZyZXF1ZW5jeRgFIAEoAlIQYXZlcmFnZUZyZXF1ZW5jeRIgCgtpbXByZXNzaW9ucxgGIAEoBVILaW1wcmVzc2lvbnMSEgoEZ3JwcxgHIAEoAlIEZ3Jwcxq1AgoWUmVwb3J0aW5nVW5pdE1ldHJpY1NldBJyCg5ub25fY3VtdWxhdGl2ZRgBIAEoCzJLLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0LkJhc2ljTWV0cmljU2V0Ug1ub25DdW11bGF0aXZlEmsKCmN1bXVsYXRpdmUYAiABKAsySy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5CYXNpY01ldHJpY1NldFIKY3VtdWxhdGl2ZRI6ChlzdGFja2VkX2luY3JlbWVudGFsX3JlYWNoGAMgAygFUhdzdGFja2VkSW5jcmVtZW50YWxSZWFjaBonCg9VbmlxdWVNZXRyaWNTZXQSFAoFcmVhY2gYASABKAVSBXJlYWNoGvkDChJDb21wb25lbnRNZXRyaWNTZXQScgoObm9uX2N1bXVsYXRpdmUYASABKAsySy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5CYXNpY01ldHJpY1NldFINbm9uQ3VtdWxhdGl2ZRJrCgpjdW11bGF0aXZlGAIgASgLMksud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5SZXN1bHRHcm91cC5NZXRyaWNTZXQuQmFzaWNNZXRyaWNTZXRSCmN1bXVsYXRpdmUSgAEKFW5vbl9jdW11bGF0aXZlX3VuaXF1ZRgEIAEoCzJMLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0LlVuaXF1ZU1ldHJpY1NldFITbm9uQ3VtdWxhdGl2ZVVuaXF1ZRJ5ChFjdW11bGF0aXZlX3VuaXF1ZRgFIAEoCzJMLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0LlVuaXF1ZU1ldHJpY1NldFIQY3VtdWxhdGl2ZVVuaXF1ZUoECAMQBBqhAQomRGF0YVByb3ZpZGVyQ29tcG9uZW50TWV0cmljU2V0TWFwRW50cnkSEAoDa2V5GAEgASgJUgNrZXkSZQoFdmFsdWUYAiABKAsyTy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5Db21wb25lbnRNZXRyaWNTZXRSBXZhbHVlGsICCipEYXRhUHJvdmlkZXJDb21wb25lbnRJbnRlcnNlY3Rpb25NZXRyaWNTZXQSMwoWY21tc19kYXRhX3Byb3ZpZGVyX2lkcxgBIAMoCVITY21tc0RhdGFQcm92aWRlcklkcxJyCg5ub25fY3VtdWxhdGl2ZRgCIAEoCzJLLndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0LkJhc2ljTWV0cmljU2V0Ug1ub25DdW11bGF0aXZlEmsKCmN1bXVsYXRpdmUYAyABKAsySy53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwLk1ldHJpY1NldC5CYXNpY01ldHJpY1NldFIKY3VtdWxhdGl2ZRrEAQoGUmVzdWx0El0KCG1ldGFkYXRhGAEgASgLMkEud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5SZXN1bHRHcm91cC5NZXRyaWNNZXRhZGF0YVIIbWV0YWRhdGESWwoKbWV0cmljX3NldBgCIAEoCzI8LndmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIuUmVzdWx0R3JvdXAuTWV0cmljU2V0UgltZXRyaWNTZXRCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCtkCCkd3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2Jhc2ljX3JlcG9ydF9yZXN1bHRfZGV0YWlscy5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mho4d2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9yZXN1bHRfZ3JvdXAucHJvdG8icwoYQmFzaWNSZXBvcnRSZXN1bHREZXRhaWxzElcKDXJlc3VsdF9ncm91cHMYASADKAsyMi53ZmEubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyLlJlc3VsdEdyb3VwUgxyZXN1bHRHcm91cHNCMAosb3JnLndmYW5ldC5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjJQAWIGcHJvdG8zCpEECkt3ZmEvbWVhc3VyZW1lbnQvaW50ZXJuYWwvcmVwb3J0aW5nL3YyL2ltcHJlc3Npb25fcXVhbGlmaWNhdGlvbl9maWx0ZXIucHJvdG8SJXdmYS5tZWFzdXJlbWVudC5pbnRlcm5hbC5yZXBvcnRpbmcudjIaUHdmYS9tZWFzdXJlbWVudC9pbnRlcm5hbC9yZXBvcnRpbmcvdjIvaW1wcmVzc2lvbl9xdWFsaWZpY2F0aW9uX2ZpbHRlcl9zcGVjLnByb3RvIuoBCh1JbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlchJcCitleHRlcm5hbF9pbXByZXNzaW9uX3F1YWxpZmljYXRpb25fZmlsdGVyX2lkGAEgASgJUidleHRlcm5hbEltcHJlc3Npb25RdWFsaWZpY2F0aW9uRmlsdGVySWQSawoMZmlsdGVyX3NwZWNzGAIgAygLMkgud2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52Mi5JbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlclNwZWNSC2ZpbHRlclNwZWNzQlQKLG9yZy53ZmFuZXQubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyQiJJbXByZXNzaW9uUXVhbGlmaWNhdGlvbkZpbHRlclByb3RvUAFiBnByb3RvMwr8BAo6d2ZhL21lYXN1cmVtZW50L2ludGVybmFsL3JlcG9ydGluZy92Mi9yZXBvcnRfcmVzdWx0cy5wcm90bxIld2ZhLm1lYXN1cmVtZW50LmludGVybmFsLnJlcG9ydGluZy52MiKrAgoMUmVwb3J0UmVzdWx0Ej8KHGNtbXNfbWVhc3VyZW1lbnRfY29uc3VtZXJfaWQYASABKANSGWNtbXNNZWFzdXJlbWVudENvbnN1bWVySWQSKAoQcmVwb3J0X3Jlc3VsdF9pZBgCIAEoA1IOcmVwb3J0UmVzdWx0SWQiUwoTTWV0cmljRnJlcXVlbmN5VHlwZRIlCiFNRVRSSUNfRlJFUVVFTkNZX1RZUEVfVU5TUEVDSUZJRUQQABIJCgVUT1RBTBABEgoKBldFRUtMWRACIlsKFVZlbm5EaWFncmFtUmVnaW9uVHlwZRIoCiRWRU5OX0RJQUdSQU1fUkVHSU9OX1RZUEVfVU5TUEVDSUZJRUQQABIJCgVVTklPThABEg0KCVBSSU1JVElWRRACIq4BCg1CYXNlTWV0cmljU2V0EicKD3BvcHVsYXRpb25fc2l6ZRgBIAEoBVIOcG9wdWxhdGlvblNpemUadAoYTm9uRGVyaXZlZEJhc2ljTWV0cmljU2V0EhQKBXJlYWNoGAEgASgFUgVyZWFjaBIgCgxrX3BsdXNfcmVhY2gYAiADKAVSCmtQbHVzUmVhY2gSIAoLaW1wcmVzc2lvbnMYAyABKAVSC2ltcHJlc3Npb25zQjAKLG9yZy53ZmFuZXQubWVhc3VyZW1lbnQuaW50ZXJuYWwucmVwb3J0aW5nLnYyUAFiBnByb3RvMw==';

START BATCH DDL;

-- Create the initial proto bundle with all types defined in the FileDescriptorSet.
CREATE PROTO BUNDLE (
  `wfa.measurement.internal.reporting.v2.EventTemplateField`,
  `wfa.measurement.internal.reporting.v2.EventTemplateField.FieldValue`,
  `wfa.measurement.internal.reporting.v2.EventFilter`,
  `wfa.measurement.internal.reporting.v2.ImpressionQualificationFilterSpec`,
  `wfa.measurement.internal.reporting.v2.ImpressionQualificationFilterSpec.MediaType`,
  `wfa.measurement.internal.reporting.v2.ReportingImpressionQualificationFilter`,
  `google.type.Date`,
  `google.protobuf.Duration`,
  `google.type.DateTime`,
  `google.type.TimeZone`,
  `wfa.measurement.internal.reporting.v2.ReportingInterval`,
  `wfa.measurement.internal.reporting.v2.BasicReportDetails`,
  `google.type.DayOfWeek`,
  `wfa.measurement.internal.reporting.v2.MetricFrequencySpec`,
  `google.protobuf.Timestamp`,
  `wfa.measurement.internal.reporting.v2.ResultGroup`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricMetadata`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricMetadata.ReportingUnitComponentSummary`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricMetadata.ReportingUnitComponentSummary.EventGroupSummary`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricMetadata.ReportingUnitSummary`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricMetadata.DimensionSpecSummary`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet.BasicMetricSet`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet.ReportingUnitMetricSet`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet.ComponentMetricSet`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet.DataProviderComponentMetricSetMapEntry`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.MetricSet.DataProviderComponentIntersectionMetricSet`,
  `wfa.measurement.internal.reporting.v2.ResultGroup.Result`,
  `wfa.measurement.internal.reporting.v2.BasicReportResultDetails`,
  `wfa.measurement.internal.reporting.v2.BaseMetricSet.NonDerivedBasicMetricSet`,
);

-- Create a place holder for supporting multiple EventTemplates concurrently
--CREATE TABLE EventTemplates (
--  EventTemplateId INT64 NOT NULL
--) PRIMARY KEY (EventTemplateId);

-- This table should be defined/altered as part of configuring the system and/or updating
-- the EventTemplate version.
-- Alternatively this table could just be kept in memory in the internal server
-- If kept in memory the above table won't be necessary. Preference would be to keep this in
-- memory to start with and if it gets too big to keep it in a DB.
--
-- Create a column per event template dimension that can be grouped by. It's type is "string" and represents all
-- of the values the event template field can take on.
--CREATE TABLE EventTemplateDimensions (
--  EventTemplateId INT64 NOT NULL,
  -- This should be globally unique so we can use it as a join key on ReportResultDimensions
--  EventTemplateDimensionId INT64 NOT NULL,

--  EventTemplateVersion INT64 NOT NULL,
--) PRIMARY KEY (EventTemplateId, EventTemplateDimension);

-- Describes the event template dimensions that the results are filtered to
CREATE TABLE ReportResultStaticDimensions (
  ReportResultStaticDimensionId INT64 NOT NULL,

  -- The IQF for which these results were computed. Can be either IQF ID or
  -- custom. In the future this column could be nullable if we decide to make
  -- IQFs optional and/or deprecate them.
  ImpressionQualificationFilter STRING(MAX) NOT NULL,

  -- org.wfanet.measurement.internal.reporting.v2.ReportResult.MetricFrequencyType enum
  -- encoded as an integer.
  MetricFrequencyType INT64 NOT NULL,

  -- org.wfanet.measurement.internal.reporting.v2.ReportResult.VennDiagramRegionType enum
  -- encoded as an integer.
  VennDiagramRegionType INT64 NOT NULL
) PRIMARY KEY (ReportResultStaticDimensionId);

CREATE UNIQUE INDEX ReportResultStaticDimensionsIndex
  ON ReportResultStaticDimensions (ImpressionQualificationFilter, MetricFrequencyType, VennDiagramRegionType);

-- reference this table in basic report. If this table is referenced then the details should NOT be
-- set
CREATE TABLE ReportResults (
  MeasurementConsumerId INT64 NOT NULL,
  ReportResultId INT64 NOT NULL,

  -- This is the start time of the set of results. Dates in child tables
  -- are with respect to the time defined by this timestamp. This is also
  -- used to indicate the start date for cumulative results in the child tables
  ReportIntervalStartTime TIMESTAMP NOT NULL,

  CreateTime TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp = true),

  FOREIGN KEY (MeasurementConsumerId) REFERENCES MeasurementConsumers (MeasurementConsumerId)
) PRIMARY KEY (MeasurementConsumerId, ReportResultId),
  INTERLEAVE IN PARENT MeasurementConsumers ON DELETE CASCADE;

-- This being a child table of the above ensures that results for all ReportingSets for a given
-- ReportResult are physically nearby.
CREATE TABLE ReportResultDimensions (
  MeasurementConsumerId INT64 NOT NULL,
  ReportResultId INT64 NOT NULL,
  ReportDimensionId INT64 NOT NULL,

  -- ReportingSetId is the Postgres ReportingSetId
  -- This corresponds to the ReportingSet for which the results are computed.
  -- We expect that all ReportingSets referenced here represent only unions of
  -- EventGroups.
  ReportingSetId String(63) NOT NULL,

  ReportResultStaticDimensionId INT64 NOT NULL,
  EventTemplateDimensionId INT64 NOT NULL,

  -- The start date for non-cumulative results in this row
  ResultWindowStartDate DATE NOT NULL,

  -- The end date for results in this row
  ResultWindowEndDate DATE NOT NULL,

  Filter `wfa.measurement.internal.reporting.v2.EventFilter`,

  CreateTime TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp = true),

  FOREIGN KEY (MeasurementConsumerId, ReportResultId)
    REFERENCES ReportResults (MeasurementConsumerId, ReportResultId),
  FOREIGN KEY (ReportResultStaticDimensionId)
    REFERENCES ReportResultStaticDimensions (ReportResultStaticDimensionId)
) PRIMARY KEY (MeasurementConsumerId, ReportResultId, ReportDimensionId),
  INTERLEAVE IN PARENT ReportResults ON DELETE CASCADE;

CREATE UNIQUE INDEX ReportResultDimensionsIndex
  ON ReportResultDimensions (ReportingSetId, ReportResultStaticDimensionId, EventTemplateDimensionId, Filter);

CREATE TABLE ReportResultValues (
  MeasurementConsumerId INT64 NOT NULL,
  ReportResultId INT64 NOT NULL,
  ReportDimensionId INT64 NOT NULL,
  ReportResultValueId INT64 NOT NULL,

  PopulationSize INT64,

  CumulativeResults `wfa.measurement.internal.reporting.v2.BaseMetricSet.NonDerivedBasicMetricSet`,
  NonCumulativeResults `wfa.measurement.internal.reporting.v2.BaseMetricSet.NonDerivedBasicMetricSet`,

  CreateTime TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp = true),

  FOREIGN KEY (MeasurementConsumerId, ReportResultId, ReportDimensionId)
    REFERENCES ReportResultDimensions (MeasurementConsumerId, ReportResultId, ReportDimensionId)
) PRIMARY KEY (MeasurementConsumerId, ReportResultId, ReportDimensionId, ReportResultValueId),
  INTERLEAVE IN PARENT ReportResultDimensions ON DELETE CASCADE;


CREATE TABLE NoisyReportResultValues (
  MeasurementConsumerId INT64 NOT NULL,
  ReportResultId INT64 NOT NULL,
  ReportDimensionId INT64 NOT NULL,
  NoisyReportResultValueId INT64 NOT NULL,

  PopulationSize INT64,

  CumulativeResults `wfa.measurement.internal.reporting.v2.BaseMetricSet.NonDerivedBasicMetricSet`,
  NonCumulativeResults `wfa.measurement.internal.reporting.v2.BaseMetricSet.NonDerivedBasicMetricSet`,

  CreateTime TIMESTAMP NOT NULL OPTIONS (allow_commit_timestamp = true),

  FOREIGN KEY (MeasurementConsumerId, ReportResultId, ReportDimensionId)
    REFERENCES ReportResultDimensions (MeasurementConsumerId, ReportResultId, ReportDimensionId)
) PRIMARY KEY (MeasurementConsumerId, ReportResultId, ReportDimensionId, NoisyReportResultValueId),
  INTERLEAVE IN PARENT ReportResultDimensions ON DELETE CASCADE;

ALTER TABLE BasicReports ADD COLUMN ReportResultId INT64;
ALTER TABLE BasicReports ALTER COLUMN BasicReportResultDetails `wfa.measurement.internal.reporting.v2.BasicReportResultDetails`;

RUN BATCH;
