// Copyright 2025 The Cross-Media Measurement Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package wfa.measurement.internal.edpaggregator;

import "google/protobuf/timestamp.proto";
// Import the message definitions used by this service.
import "wfa/measurement/internal/edpaggregator/requisition_metadata.proto";
import "wfa/measurement/internal/edpaggregator/requisition_metadata_state.proto";

option java_package = "org.wfanet.measurement.internal.edpaggregator";
option java_multiple_files = true;
option java_outer_classname = "RequisitionMetadataServiceProto";

// Service for managing RequisitionMetadata.
service RequisitionMetadataService {
  // Creates a new RequisitionMetadata entry.
  // To create a resource in the REFUSED state, provide a non-empty
  // `refusal_message`. Otherwise, it will be created in the STORED state.
  rpc CreateRequisitionMetadata(CreateRequisitionMetadataRequest)
      returns (RequisitionMetadata);

  // Creates multiple new RequisitionMetadata entries in a single request.
  rpc BatchCreateRequisitionMetadata(BatchCreateRequisitionMetadataRequest)
      returns (BatchCreateRequisitionMetadataResponse);

  // Retrieves a specific RequisitionMetadata entry by its IDs.
  rpc GetRequisitionMetadata(GetRequisitionMetadataRequest)
      returns (RequisitionMetadata);

  // Looks up a single RequisitionMetadata resource by an alternative key.
  rpc LookupRequisitionMetadata(LookupRequisitionMetadataRequest)
      returns (RequisitionMetadata);

  // Streams RequisitionMetadata, ordered by update_time asc,
  // external_data_provider_id asc, and external_requisition_metadata_id asc.
  rpc StreamRequisitionMetadata(StreamRequisitionMetadataRequest)
      returns (stream RequisitionMetadata);

  // Fetches the latest cmms_create_time for a given DataProvider. This is used
  // to determine the starting point for fetching new requisitions from the
  // Kingdom.
  rpc FetchLatestCmmsCreateTime(FetchLatestCmmsCreateTimeRequest)
      returns (google.protobuf.Timestamp);

  // Transitions a RequisitionMetadata resource to the QUEUED state.
  rpc QueueRequisitionMetadata(QueueRequisitionMetadataRequest)
      returns (RequisitionMetadata);

  // Transitions a RequisitionMetadata resource to the PROCESSING state.
  rpc StartProcessingRequisitionMetadata(
      StartProcessingRequisitionMetadataRequest) returns (RequisitionMetadata);

  // Transitions a RequisitionMetadata resource to the FULFILLED state.
  rpc FulfillRequisitionMetadata(FulfillRequisitionMetadataRequest)
      returns (RequisitionMetadata);

  // Transitions a RequisitionMetadata resource to the REFUSED state.
  rpc RefuseRequisitionMetadata(RefuseRequisitionMetadataRequest)
      returns (RequisitionMetadata);
}

message CreateRequisitionMetadataRequest {
  RequisitionMetadata requisition_metadata = 1;
  // The request_id is used for idempotency.
  string request_id = 2;
}

message BatchCreateRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  // To create a resource in the REFUSED state, provide a non-empty
  // `refusal_message` in the RequisitionMetadata object. Otherwise, it will be
  // created in the STORED state.
  repeated RequisitionMetadata requisitions = 2;
}

message BatchCreateRequisitionMetadataResponse {
  repeated RequisitionMetadata requisition_metadata = 1;
}

message GetRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  fixed64 external_requisition_metadata_id = 2;
}

message LookupRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  oneof lookup_key {
    // The resource name of the requisition in the CMMS (Kingdom).
    string cmms_requisition = 2;
    // The blob storage URI.
    string blob_uri = 3;
  }
}

message StreamRequisitionMetadataRequest {
  message AfterFilter {
    google.protobuf.Timestamp update_time = 1;
    fixed64 external_data_provider_id = 2;
    fixed64 external_requisition_metadata_id = 3;
  }

  message Filter {
    fixed64 external_data_provider_id = 1;
    RequisitionMetadataState state = 2;
    string group_id = 3;
    AfterFilter after = 4;
  }
  Filter filter = 1;

  // The maximum number of results to return. If not specified or 0, it implies
  // unlimited.
  int32 limit = 2;
}

message FetchLatestCmmsCreateTimeRequest {
  fixed64 external_data_provider_id = 1;
}

message QueueRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  fixed64 external_requisition_metadata_id = 2;
  string etag = 3;
  // The resource name of the WorkItem to associate with this requisition.
  string work_item = 4;
}

message StartProcessingRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  fixed64 external_requisition_metadata_id = 2;
  string etag = 3;
}

message FulfillRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  fixed64 external_requisition_metadata_id = 2;
  string etag = 3;
}

message RefuseRequisitionMetadataRequest {
  fixed64 external_data_provider_id = 1;
  fixed64 external_requisition_metadata_id = 2;
  string etag = 3;
  // A human-readable message explaining the reason for refusal.
  string refusal_message = 4;
}
