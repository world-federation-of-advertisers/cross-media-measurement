// Copyright 2025 The Cross-Media Measurement Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

syntax = "proto3";

package wfa.measurement.internal.reporting.v2;

import "google/type/date.proto";
import "google/type/datetime.proto";
import "wfa/measurement/internal/reporting/v2/event_filter.proto";
import "wfa/measurement/internal/reporting/v2/event_template_field.proto";
import "wfa/measurement/internal/reporting/v2/metric_frequency_spec.proto";
import "wfa/measurement/internal/reporting/v2/result_group.proto";

option java_package = "org.wfanet.measurement.internal.reporting.v2";
option java_multiple_files = true;

// Entity representing a result of a Basic or Advanced report.
message ReportResult {
  // MeasurementConsumer ID from the CMMS public API. Identifier.
  string cmms_measurement_consumer_id = 1;
  // External ID of this ReportResult. Identifier.
  fixed64 external_report_result_id = 2;

  // Report start time. Required. Immutable.
  google.type.DateTime report_start = 3;
}

// Entity representing a result for a dimension of a ReportingSet for a
// ReportResult.
message ReportingSetResult {
  // MeasurementConsumer ID from the CMMS public API.  Identifier.
  string cmms_measurement_consumer_id = 1;
  // External ID of the parent ReportResult.  Identifier.
  fixed64 external_report_result_id = 2;
  // External ID of this ReportingSetResult.  Identifier.
  fixed64 external_reporting_set_result_id = 3;

  message Dimension {
    // External ID of the `ReportingSet`. Required. Immutable.
    string external_reporting_set_id = 1;

    enum VennDiagramRegionType {
      VENN_DIAGRAM_REGION_TYPE_UNSPECIFIED = 0;
      // Indicates that the metrics for a ReportingSet are for the
      // union of the entailed ReportingSets
      UNION = 1;
      // Indicates that the metrics for a ReportingSet are for the
      // primitive Venn diagram region entailed by sub-ReportingSets
      PRIMITIVE = 2;
    }
    // Type of the Venn diagram region. Required. Immutable.
    VennDiagramRegionType venn_diagram_region_type = 2;

    // Impression qualification filter. Required. Immutable.
    oneof impression_qualification_filter {
      // The external ID of the IQF.
      string external_impression_qualification_filter_id = 3;
      // Whether the filter is custom.
      bool custom = 4;
    }
    // Frequency specification. Required.
    MetricFrequencySpec metric_frequency_spec = 5;

    message Grouping {
      // Map of field path to value.
      map<string, EventTemplateField.FieldValue> value_by_path = 1;
    }
    // Grouping where each field path corresponds to an element in the
    // `event_template_fields` field of `DimensionSpec.Grouping`. Immutable.
    Grouping grouping = 6;

    // Event `filters` field from the `DimensionSpec`, ordered by `terms`
    // lexicographically. Immutable.
    //
    // The terms themselves are ordered by `path` and `value`, following the
    // natural order of the value type.
    repeated EventFilter event_filters = 7;
  }
  // ReportingSet dimension. This is unique within a parent `ReportResult`.
  Dimension dimension = 4;

  // Size of the population. Required. Immutable.
  int32 population_size = 5;

  // Window for report results.
  //
  // This implicitly covers up to two logical windows with the same end date:
  // 1. The window for cumulative metrics, which starts at `report_start`
  // 2. The window for non-cumulative metrics, which starts at
  // `non_cumulative_start`.
  //
  // The time of day is implicitly the time in `report_start`.
  message ReportingWindow {
    // Start of the window range for non-cumulative metrics, inclusive.
    //
    // Required if there are non-cumulative metrics in the corresponding
    // `ReportingWindowResult`.
    google.type.Date non_cumulative_start = 1;
    // End of the window range, inclusive. Required.
    google.type.Date end = 2;
  }
  message ReportingWindowResult {
    // Represents noisy result values with respect to a ReportingWindowResult.
    // Immutable.
    message NoisyReportResultValues {
      message NoisyMetricSet {
        // Statistics of a scalar value
        message UnivariateStatistics {
          // The standard deviation of the associated scalar variable value.
          //
          // Can be used to find different confidence intervals.
          double standard_deviation = 1;
        }

        message ReachResult {
          int64 value = 1;
          UnivariateStatistics univariate_statistics = 2;
        }

        message HistogramResult {
          message BinResult {
            int32 value = 1;
            UnivariateStatistics univariate_statistics = 2;
          }
          // Map of bin to the result for that bin.
          map<int32, BinResult> bin_results = 1;
        }

        message ImpressionCountResult {
          int64 value = 1;
          UnivariateStatistics univariate_statistics = 2;
        }

        ReachResult reach = 1;
        // Histogram where each bin is the frequency `k` and each result value
        // is the `k` reach of that bin. The largest bin represents the
        // maximum frequency, where the result value is the `k+` reach of that
        // bin.
        HistogramResult frequency_histogram = 2;
        ImpressionCountResult impression_count = 3;
      }

      NoisyMetricSet cumulative_results = 1;
      NoisyMetricSet non_cumulative_results = 2;
    }

    // Represents result values with respect to a ReportingWindowResult.
    // Immutable.
    message ReportResultValues {
      ResultGroup.MetricSet.BasicMetricSet cumulative_results = 1;
      ResultGroup.MetricSet.BasicMetricSet non_cumulative_results = 2;
    }

    // Unprocessed report result values. Required. Immutable.
    NoisyReportResultValues unprocessed_report_result_values = 1;

    // Processed report result values. Output-only.
    //
    // In responses, only set when view is `REPORTING_SET_RESULT_VIEW_FULL`.
    ReportResultValues processed_report_result_values = 2;
  }
  message ReportingWindowEntry {
    ReportingWindow key = 1;
    ReportingWindowResult value = 2;
  }
  // Map of `ReportingWindow` to `ReportingWindowResult`.
  repeated ReportingWindowEntry reporting_window_results = 6;

  // Fingerprint of `ReportingSetResult.Dimension.metric_frequency_spec`.
  // Output-only.
  fixed64 metric_frequency_spec_fingerprint = 7;

  // Fingerprint of `ReportingSetResult.Dimension.grouping`. Output-only.
  fixed64 grouping_dimension_fingerprint = 8;

  // Fingerprint of `ReportingSetResult.Dimension.event_filters`. Output-only.
  fixed64 filter_fingerprint = 9;
}

enum ReportingSetResultView {
  // Default value. The API will default to the UNPROCESSED view.
  REPORTING_SET_RESULT_VIEW_UNSPECIFIED = 0;
  // View which includes unprocessed values only.
  REPORTING_SET_RESULT_VIEW_UNPROCESSED = 1;
  // View which includes all values (unprocessed and processed).
  REPORTING_SET_RESULT_VIEW_FULL = 2;
}
