// Copyright 2025 The Cross-Media Measurement Authors
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//      http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

// (-- api-linter: all=disabled
//     aip.dev/not-precedent: This file needs to be updated to comply with AIPs.
//     --)
//  TODO(world-federation-of-advertisers/cross-media-measurement#2777): Update
//  to comply AIPs.

syntax = "proto3";

package wfa.measurement.edpaggregator.v1alpha;

import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "wfa/measurement/edpaggregator/v1alpha/unified_transport_layer_security_params.proto";

option java_package = "org.wfanet.measurement.edpaggregator.v1alpha";
option java_multiple_files = true;
option java_outer_classname = "ResultsFulfillerParamsProto";

// Message representing the params used for the results fulfiller tee app
message ResultsFulfillerParams {
  // The Cmms Resource name for the EDP
  string data_provider = 1;
  // Message representing the storage details used by the results fulfiller app
  message StorageParams {
    // The blob uri prefix for the labeled impressions `BlobDetails` that is
    // stored in GCS for a given EDP
    // See reference:
    // https://github.com/world-federation-of-advertisers/common-jvm/blob/main/src/main/kotlin/org/wfanet/measurement/storage/SelectedStorageClient.kt
    string labeled_impressions_blob_details_uri_prefix = 1
        [(google.api.field_behavior) = REQUIRED];

    // The Project ID for the requisitions GCS instance that can be
    // used with a blob URI to retrieve the data. Optional.
    string gcs_project_id = 4;
  }

  // The storage used by the tee app
  StorageParams storage_params = 2 [(google.api.field_behavior) = REQUIRED];

  // Message representing the details needed to generate certificates
  message ConsentParams {
    // The resource key of the DER-encoded certificate file used for result
    // signing
    string result_cs_cert_der_resource_path = 1
        [(google.api.field_behavior) = REQUIRED];

    // The resource key of the DER-encoded private key file used for result
    // signing
    string result_cs_private_key_der_resource_path = 2
        [(google.api.field_behavior) = REQUIRED];

    // The resource key of the private encryption key file
    string private_encryption_key_resource_path = 3
        [(google.api.field_behavior) = REQUIRED];

    // The name for the certificate used by the EDP
    string edp_certificate_name = 4 [
      (google.api.resource_reference).type = "halo.wfanet.org/Certificate",
      (google.api.field_behavior) = REQUIRED
    ];
  }

  // Information necessary for EDP Consent signaling
  ConsentParams consent_params = 3 [(google.api.field_behavior) = REQUIRED];

  // Deprecated: Use UnifiedTransportLayerSecurityParams instead.
  // TLS client credential resource paths used by a TEE application to connect
  // to an mTLS-secured API.
  message TransportLayerSecurityParams {
    option deprecated = true;

    // The resource key of the client certificate
    string client_cert_resource_path = 1
        [(google.api.field_behavior) = REQUIRED];

    // The resource key of the client private key
    string client_private_key_resource_path = 2
        [(google.api.field_behavior) = REQUIRED];
  }

  // Deprecated: Use unified_cmms_connection instead.
  TransportLayerSecurityParams cmms_connection = 4 [deprecated = true];

  // The parameters for noise that is applied to the result.
  message NoiseParams {
    // The types of noise
    enum NoiseType {
      // Default/unset.
      UNSPECIFIED = 0;
      // No noise applied.
      NONE = 1;
      // Continuous gaussian noise applied.
      CONTINUOUS_GAUSSIAN = 2;
    }
    // The type of noise applied to the result
    NoiseType noise_type = 1;
  }

  // The noise params to be applied.
  NoiseParams noise_params = 5;

  // The parameters for k-anonymity that is applied to the result. Note that if
  // the threshold is not met, a zero result is returned instead.
  message KAnonymityParams {
    // The minimum number of impressions.
    int32 min_impressions = 1;
    // The minimum number of unique users.
    int32 min_users = 2;
    // The maximum frequency used for impression count in reach measurements.
    // Note that this param is also used to set sensitivity if differential
    // privacy is also applied.
    int32 reach_max_frequency_per_user = 3;
  }

  // The k-anonymity params to be applied.
  KAnonymityParams k_anonymity_params = 6;

  // The maximum frequency used for impression count in impression measurements.
  // Only apply for direct measurements.
  int32 impression_max_frequency_per_user = 7;

  // Optional mapping from a requisition model line to the model line used for
  // impression lookup in storage.
  //
  // This is the inverse of the data availability sync mapping:
  // - Results fulfiller: external (requisition) model line -> internal (EDPA)
  // model line
  // - Data availability: internal (EDPA) model line -> external model lines
  //
  // When a requisition model line exists in this map, the fulfiller uses the
  // mapped value to locate impression files. This supports cases where an
  // external model line name changes, where multiple external model lines
  // should map to a single internal model line, or where a deleted model line
  // known by the EDP maps to a replacement model line known by the kingdom.
  map<string, string> model_line_map = 8;

  // Parameters for TrusTee protocol envelope encryption.
  message TrusTeeParams {
    // Map of KEK URI to key name for re-encryption.
    // The key is the KEK URI that was used to encrypt the input data.
    // The value is the key name on the same key ring that will be used to
    // re-encrypt the data for TrusTee.
    // The key name must exist on the same key ring that is used for the input
    // data. If a KEK URI is not present in this map, the same KEK URI will be
    // used to both encrypt and decrypt the data. Example key:
    // "gcp-kms://projects/my-project/locations/global/keyRings/
    //  my-ring/cryptoKeys/input-key"
    // Example value: "trustee-key"
    map<string, string> kek_uri_to_key_name = 1;
  }

  // TrusTee encryption parameters. Required for TrusTee protocol support.
  TrusTeeParams trustee_params = 9;

  // The connection to the Cmms API
  UnifiedTransportLayerSecurityParams unified_cmms_connection = 10
      [(google.api.field_behavior) = REQUIRED];
}
